<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STOCK-VISION</title>
  <link rel="stylesheet" href="../styles/productos-sin-codigo.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <a href="admin.html" class="back-btn">â¬… Volver al Panel</a>
    <a href="inventario.html" class="back-btn">â¬… Volver al Panel de inventario</a>
    <h1>Inventario de Productos sin cÃ³digo</h1>

    <!-- Leyenda de colores -->
    <div class="color-legend">
      <div class="legend-item">
        <div class="legend-box green"></div>
        <span>Stock suficiente (mÃ¡s de 10)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box yellow"></div>
        <span>Stock medio (entre 2 y 10)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box red"></div>
        <span>Stock crÃ­tico (1 o menos)</span>
      </div>
    </div>

    <div class="actions-header">
      <input type="text" id="searchInput" placeholder="Buscar por descripciÃ³n...">
      <button class="btn-add" id="btnOpenModal">âž• Agregar Producto</button>
      <button id="refreshReport" class="generate-btn" title="Refrescar datos">ðŸ”„ Refrescar</button>
      <button class="btn-salidas" id="btnVerSalidas" onclick="window.location.href='salidas-sin-codigo.html'">ðŸ“‹ Ver Salidas</button> 
    </div>
    
    <div class="table-scroll-container">
      <table id="inventoryTable">
        <thead>
        <tr>
         <th>CÃ³digo</th>
         <th>DescripciÃ³n</th>
          <th>UM</th>
         <th>INVENTARIO I069</th>
         <th>INVENTARIO I078</th>
         <th>INVENTARIO I07F</th>
         <th>INVENTARIO I312</th>
         <th>INVENTARIO I073</th>
         <th>INVENTARIO FISICO EN ALMACEN</th>
          <th class="acciones-head">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los productos se cargarÃ¡n dinÃ¡micamente aquÃ­ -->
        </tbody>
      </table>
    </div>

    <!-- Controles de PaginaciÃ³n Compactos - AHORA ABAJO DE LA TABLA -->
    <div id="paginationControls" class="pagination-compact" style="display: none;">
      <!-- Los controles se generan dinÃ¡micamente aquÃ­ -->
    </div>

    <!-- Indicador de carga -->
    <div id="loadingIndicator" style="display: none;">
      <!-- Se muestra durante la carga -->
    </div>
</div>

 <!-- Modal para agregar/editar producto -->
  <div class="modal" id="modalForm">
    <div class="modal-content">
      <span class="close" id="btnCloseModal">&times;</span>
      <h2 id="modalTitle">Agregar Producto</h2>
      <form id="productForm">
        <!-- ELIMINADO EL CAMPO CÃ“DIGO -->
        <div class="form-row">
          <div class="form-group">
            <label>DescripciÃ³n:</label>
            <input type="text" name="descripcion" required>
          </div>
          <div class="form-group">
            <label>UM:</label>
            <input list="unidades" name="um" required>
            <datalist id="unidades">
              <option value="PZA">
              <option value="M">
              <option value="M2">
              <option value="KG">
              <option value="JGO"> 
              <option value="L">
              <option value="MIL">
              <option value="CAJ">
              <option value="PAQ">
            </datalist>
          </div>
        </div>

        <!-- CAMPOS DE INVENTARIO OCULTOS (se llenan automÃ¡ticamente con 0) -->
        <div style="display: none;">
          <div class="form-row">
            <div class="form-group">
              <label>Inventario I069:</label>
              <input type="number" name="i069" min="0" value="0" readonly>
            </div>
            <div class="form-group">
              <label>Inventario I078:</label>
              <input type="number" name="i078" min="0" value="0" readonly>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Inventario I07F:</label>
              <input type="number" name="i07f" min="0" value="0" readonly>
            </div>
            <div class="form-group">
              <label>Inventario I312:</label>
              <input type="number" name="i312" min="0" value="0" readonly>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Inventario I073:</label>
              <input type="number" name="i073" min="0" value="0" readonly>
            </div>
            <div class="form-group">
              <label>Inventario FÃ­sico en AlmacÃ©n:</label>
              <input type="number" name="almacen" id="almacen" value="0" readonly>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" id="btnCancelModal">Cancelar</button>
          <button type="submit" class="btn-save">ðŸ’¾ Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- NotificaciÃ³n personalizada -->
  <div id="toast" class="toast"></div>

  <!-- Modal ConfirmaciÃ³n -->
  <div id="confirmModal" class="custom-modal">
    <div class="custom-modal-content">
      <h3>âš  Confirmar AcciÃ³n</h3>
      <p id="confirmMessage">Â¿Seguro que deseas eliminar este producto?</p>
      <div class="modal-buttons">
        <button id="btnConfirmYes" class="btn-yes">SÃ­, eliminar</button>
        <button id="btnConfirmNo" class="btn-no">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para ver salidas -->
  <div id="modalSalidas" class="modal">
    <div class="modal-content">
      <span id="btnCloseSalidas" class="close">&times;</span>
      <h2>Historial de Salidas</h2>
      <table id="salidasTable">
        <thead>
          <tr>
            <th>CÃ³digo</th>
            <th>DescripciÃ³n</th>
            <th>UM</th>
            <th>Inventario Origen</th>
            <th>Cantidad</th>
            <th>Fecha</th>
            <th>Responsable</th>
            <th>Destinatario</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal unificado para registrar salida -->
  <div id="salidaModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" id="salidaCloseBtn">&times;</span>
      <h2>ðŸ“¦ Registrar Salida</h2>
      <form id="salidaForm">
        
        <div class="field">
          <label for="salidaInventarioSelect">Inventario origen</label>
          <select id="salidaInventarioSelect" required>
            <option value="">-- Selecciona inventario --</option>
            <option value="INVENTARIO I069">INVENTARIO I069</option>
            <option value="INVENTARIO I078">INVENTARIO I078</option>
            <option value="INVENTARIO I07F">INVENTARIO I07F</option>
            <option value="INVENTARIO I312">INVENTARIO I312</option>
            <option value="INVENTARIO I073">INVENTARIO I073</option>
          </select>
        </div>

        <div class="field">
          <label for="salidaCantidadInput">Cantidad</label>
          <input id="salidaCantidadInput" type="number" min="1" required />
          <small id="salidaDisponible" class="muted"></small>
        </div>

        <div class="field">
          <label for="salidaResponsableInput">Responsable</label>
          <input id="salidaResponsableInput" type="text" placeholder="Ej. Juan PÃ©rez" required />
        </div>

        <div class="field">
          <label for="salidaDestinatarioInput">Destinatario</label>
          <input id="salidaDestinatarioInput" type="text" placeholder="Ej. Cliente XYZ" required />
        </div>

        <div class="field">
          <label for="salidaObservacionesInput">Observaciones</label>
          <textarea id="salidaObservacionesInput" rows="2"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" id="salidaCancelBtn" class="secondary">Cancelar</button>
          <button type="submit" id="salidaAddBtn" class="primary">Agregar a pendientes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- CAMBIADO EL SCRIPT A productos-sin-codigo.js -->
 <script type="module" src="../js/productos-sin-codigo.js"></script>
  <script>
    // ðŸ”¹ Calcula automÃ¡ticamente el Inventario FÃ­sico en AlmacÃ©n
    const inputsInventario = ["i069", "i078", "i07f", "i312", "i073"];
    inputsInventario.forEach((name) => {
      const el = document.querySelector(`[name="${name}"]`);
      if (el) el.addEventListener("input", actualizarAlmacen);
    });
    function actualizarAlmacen() {
      let total = 0;
      inputsInventario.forEach((name) => {
        const v = parseInt(document.querySelector(`[name="${name}"]`).value);
        total += Number.isNaN(v) ? 0 : v;
      });
      const alm = document.getElementById("almacen");
      if (alm) alm.value = total;
    }

    // Asegurar que al abrir modal el checkbox "sumar" estÃ© deseleccionado por defecto
    document.addEventListener('DOMContentLoaded', () => {
      const sumar = document.getElementById('sumarCheckbox');
      if (sumar) sumar.checked = false;
    });

    // FunciÃ³n para abrir modal de salida
    function abrirModalSalida(descripcion, um, stockDisponible) {
      const modal = document.getElementById('salidaModal');
      const form = document.getElementById('salidaForm');
      
      // Limpiar formulario
      form.reset();
      
      // Configurar datos del producto
      modal.dataset.descripcion = descripcion;
      modal.dataset.um = um;
      modal.dataset.stock = stockDisponible;
      
      // Actualizar informaciÃ³n de stock disponible
      document.getElementById('salidaDisponible').textContent = `Disponible: ${stockDisponible}`;
      
      // Mostrar modal
      modal.style.display = 'block';
      
      // Enfocar en el campo de cantidad
      setTimeout(() => {
        document.getElementById('salidaCantidadInput').focus();
      }, 100);
    }

    // Event listeners para el modal de salida
    document.addEventListener('DOMContentLoaded', function() {
      const salidaModal = document.getElementById('salidaModal');
      const salidaCloseBtn = document.getElementById('salidaCloseBtn');
      const salidaCancelBtn = document.getElementById('salidaCancelBtn');
      const salidaForm = document.getElementById('salidaForm');
      
      // Cerrar modal
      salidaCloseBtn.addEventListener('click', () => {
        salidaModal.style.display = 'none';
      });
      
      salidaCancelBtn.addEventListener('click', () => {
        salidaModal.style.display = 'none';
      });
      
      // Cerrar al hacer clic fuera del modal
      window.addEventListener('click', (event) => {
        if (event.target === salidaModal) {
          salidaModal.style.display = 'none';
        }
      });
      
      // Validar cantidad antes de enviar
      document.getElementById('salidaCantidadInput').addEventListener('input', function() {
        const cantidad = parseInt(this.value);
        const stockDisponible = parseInt(salidaModal.dataset.stock);
        const boton = document.getElementById('salidaAddBtn');
        
        if (cantidad > stockDisponible) {
          this.style.borderColor = 'red';
          boton.disabled = true;
          boton.title = 'La cantidad no puede ser mayor al stock disponible';
        } else {
          this.style.borderColor = '';
          boton.disabled = false;
          boton.title = '';
        }
      });
      
      // Manejar envÃ­o del formulario de salida
      salidaForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const descripcion = salidaModal.dataset.descripcion;
        const um = salidaModal.dataset.um;
        const inventarioOrigen = document.getElementById('salidaInventarioSelect').value;
        const cantidad = parseInt(document.getElementById('salidaCantidadInput').value);
        const responsable = document.getElementById('salidaResponsableInput').value;
        const destinatario = document.getElementById('salidaDestinatarioInput').value;
        const observaciones = document.getElementById('salidaObservacionesInput').value;
        
        // Crear objeto de salida pendiente
        const salidaPendiente = {
          DESCRIPCION: descripcion,
          UM: um,
          INVENTARIO_ORIGEN: inventarioOrigen,
          CANTIDAD: cantidad,
          RESPONSABLE: responsable,
          DESTINATARIO: destinatario,
          OBSERVACIONES: observaciones,
          ADDED_AT: String(Date.now())
        };
        
        // Guardar en localStorage (usando la clave correcta para productos sin cÃ³digo)
        const pendientes = JSON.parse(localStorage.getItem('salidas_sin_codigo_pendientes') || '[]');
        pendientes.push(salidaPendiente);
        localStorage.setItem('salidas_sin_codigo_pendientes', JSON.stringify(pendientes));
        
        // Mostrar confirmaciÃ³n
        showToast(`Salida de "${descripcion}" agregada a pendientes`, true);
        
        // Cerrar modal
        salidaModal.style.display = 'none';
      });
    });

    // FunciÃ³n para mostrar notificaciÃ³n
    function showToast(message, isSuccess = true) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + (isSuccess ? 'success' : 'error');
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
  </script>
  
  <script src="../js/seguridad.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      protectPage('admin');
    });
  </script>
  
</body>
</html>