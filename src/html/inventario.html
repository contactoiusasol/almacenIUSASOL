<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STOCK-VISION</title>
  <link rel="stylesheet" href="../styles/inventario.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <a href="admin.html" class="back-btn">‚¨Ö Volver al Panel</a>
    <h1>Inventario de Productos</h1>

    <!-- Leyenda de colores -->
    <div class="color-legend">
      <div class="legend-item">
        <div class="legend-box green"></div>
        <span>Stock suficiente (m√°s de 10)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box yellow"></div>
        <span>Stock medio (entre 2 y 10)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box red"></div>
        <span>Stock cr√≠tico (1 o menos)</span>
      </div>
    </div>

    <div class="actions-header">
      <input type="text" id="searchInput" placeholder="Buscar por c√≥digo o descripci√≥n...">
      <button class="btn-add" id="btnOpenModal">‚ûï Agregar Producto</button>
      <a href="productos-sin-codigo.html" class="btn-add no-code" title="Agregar producto sin c√≥digo">‚ûï Agregar Prod. S/C</a>
      <button id="refreshReport" class="generate-btn" title="Refrescar datos">üîÑ Refrescar</button>
      <button class="btn-salidas" id="btnVerSalidas">üìã Ver Salidas</button> 
    </div>
    
    <div class="table-scroll-container">
      <table id="inventoryTable">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Descripci√≥n</th>
            <th>UM</th>
            <th>INVENTARIO I069</th>
            <th>INVENTARIO I078</th>
            <th>INVENTARIO I07F</th>
            <th>INVENTARIO I312</th>
            <th>INVENTARIO I073</th>
            <th>INVENTARIO F√çSICO EN ALMAC√âN</th>
            <th class="acciones-head">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los productos se cargar√°n din√°micamente aqu√≠ -->
        </tbody>
      </table>
    </div>

    <!-- Controles de Paginaci√≥n Compactos - AHORA ABAJO DE LA TABLA -->
    <div id="paginationControls" class="pagination-compact" style="display: none;">
      <!-- Los controles se generan din√°micamente aqu√≠ -->
    </div>

    <!-- Indicador de carga -->
    <div id="loadingIndicator" style="display: none;">
      <!-- Se muestra durante la carga -->
    </div>
</div>

 <!-- Modal para agregar/editar producto -->
  <div class="modal" id="modalForm">
    <div class="modal-content">
      <span class="close" id="btnCloseModal">&times;</span>
      <h2 id="modalTitle">Agregar Producto</h2>
      <form id="productForm">
        <div class="form-row">
          <div class="form-group">
            <label>C√≥digo:</label>
            <input type="number" name="codigo" required>
          </div>
          <div class="form-group">
            <label>UM:</label>
            <input list="unidades" name="um" required readonly>
            <datalist id="unidades">
              <option value="PZA">
              <option value="M">
              <option value="M2">
              <option value="KG">
              <option value="JGO"> 
              <option value="L">
              <option value="MIL">
              <option value="CAJ">
              <option value="PAQ">
            </datalist>
          </div>
        </div>
        
        <div class="form-group">
          <label>Descripci√≥n:</label>
          <input type="text" name="descripcion" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Inventario I069:</label>
            <input type="number" name="i069" min="0" readonly>
          </div>
          <div class="form-group">
            <label>Inventario I078:</label>
            <input type="number" name="i078" min="0" readonly>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Inventario I07F:</label>
            <input type="number" name="i07f" min="0" readonly>
          </div>
          <div class="form-group">
            <label>Inventario I312:</label>
            <input type="number" name="i312" min="0" readonly>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Inventario I073:</label>
            <input type="number" name="i073" min="0" readonly>
          </div>
          <div class="form-group">
            <label>Inventario F√≠sico en Almac√©n:</label>
            <input type="number" name="almacen" id="almacen" readonly>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" id="btnCancelModal">Cancelar</button>
          <button type="submit" class="btn-save">üíæ Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notificaci√≥n personalizada -->
  <div id="toast" class="toast"></div>

  <!-- Modal Confirmaci√≥n -->
  <div id="confirmModal" class="custom-modal">
    <div class="custom-modal-content">
      <h3>‚ö† Confirmar Acci√≥n</h3>
      <p id="confirmMessage">¬øSeguro que deseas eliminar este producto?</p>
      <div class="modal-buttons">
        <button id="btnConfirmYes" class="btn-yes">S√≠, eliminar</button>
        <button id="btnConfirmNo" class="btn-no">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para ver salidas -->
  <div id="modalSalidas" class="modal">
    <div class="modal-content">
      <span id="btnCloseSalidas" class="close">&times;</span>
      <h2>Historial de Salidas</h2>
      <table id="salidasTable">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Descripci√≥n</th>
            <th>Cantidad</th>
            <th>Observaciones</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal unificado para registrar salida -->
  <div id="salidaModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" id="salidaCloseBtn">&times;</span>
      <h2>üì¶ Registrar Salida</h2>
      <form id="salidaForm">
        
        <div class="field">
          <label for="salidaInventarioSelect">Inventario origen</label>
          <select id="salidaInventarioSelect" required>
            <option value="">-- Selecciona inventario --</option>
            <option value="I069">INVENTARIO I069</option>
            <option value="I078">INVENTARIO I078</option>
            <option value="I07F">INVENTARIO I07F</option>
            <option value="I312">INVENTARIO I312</option>
            <option value="I073">INVENTARIO I073</option>
          </select>
        </div>

        <div class="field">
          <label for="salidaCantidadInput">Cantidad</label>
          <input id="salidaCantidadInput" type="number" min="1" required />
          <small id="salidaDisponible" class="muted"></small>
        </div>

        <div class="field">
          <label for="salidaResponsableInput">Responsable (Nombre y Apellido)</label>
          <input id="salidaResponsableInput" type="text" placeholder="Ej. Juan P√©rez" required />
        </div>

        <div class="field">
          <label for="salidaObservacionesInput">Observaciones</label>
          <textarea id="salidaObservacionesInput" rows="2"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" id="salidaCancelBtn" class="secondary">Cancelar</button>
          <button type="submit" id="salidaAddBtn" class="primary">Agregar a pendientes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="../js/inventario.js"></script>

  <script>
    // üîπ Calcula autom√°ticamente el Inventario F√≠sico en Almac√©n
    const inputsInventario = ["i069", "i078", "i07f", "i312", "i073"];
    inputsInventario.forEach((name) => {
      const el = document.querySelector(`[name="${name}"]`);
      if (el) el.addEventListener("input", actualizarAlmacen);
    });
    function actualizarAlmacen() {
      let total = 0;
      inputsInventario.forEach((name) => {
        const v = parseInt(document.querySelector(`[name="${name}"]`).value);
        total += Number.isNaN(v) ? 0 : v;
      });
      const alm = document.getElementById("almacen");
      if (alm) alm.value = total;
    }

    // Asegurar que al abrir modal el checkbox "sumar" est√© deseleccionado por defecto
    document.addEventListener('DOMContentLoaded', () => {
      const sumar = document.getElementById('sumarCheckbox');
      if (sumar) sumar.checked = false;
    });
  </script>
  
  <script src="../js/seguridad.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        protectPage('admin');
    });
</script>
  
</body>
</html>